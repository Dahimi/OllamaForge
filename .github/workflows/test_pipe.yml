name: Debug Ollama Push

on:
  workflow_dispatch:

jobs:
  debug-push:
    runs-on: ubuntu-latest
    steps:
    - name: Set up authentication
      run: |
        # Set up Ollama directory
        mkdir -p ~/.ollama
        
        # Add SSH keys for namespace authentication
        cat > ~/.ollama/id_ed25519 << 'EOF'
        -----BEGIN OPENSSH PRIVATE KEY-----
        b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtz
        c2gtZWQyNTUxOQAAACDVKzYLS6x2A3Hr8RfFv2YxNhjWzXpcELALECbocn4MTQAA
        AIgvWh8bL1ofGwAAAAtzc2gtZWQyNTUxOQAAACDVKzYLS6x2A3Hr8RfFv2YxNhjW
        zXpcELALECbocn4MTQAAAEC5cwUIbXjLjlzj7md8KidpDNRvFJoPEnHdKZNTLmTu
        sdUrNgtLrHYDcevxF8W/ZjE2GNbNelwQsAsQJuhyfgxNAAAAAAECAwQF
        -----END OPENSSH PRIVATE KEY-----
        EOF
        
        cat > ~/.ollama/id_ed25519.pub << 'EOF'
        ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINUrNgtLrHYDcevxF8W/ZjE2GNbNelwQsAsQJuhyfgxN
        EOF
        
        chmod 600 ~/.ollama/id_ed25519
        chmod 644 ~/.ollama/id_ed25519.pub
        
        # Add SSH config for registry authentication
        mkdir -p ~/.ssh
        cat > ~/.ssh/config << 'EOF'
        Host registry.ollama.com registry.ollama.ai
          IdentityFile ~/.ollama/id_ed25519
          StrictHostKeyChecking no
        EOF
        chmod 600 ~/.ssh/config

    - name: Install Ollama
      run: |
        curl -fsSL https://ollama.com/install.sh | sh

    - name: Start Ollama server
      run: |
        pkill ollama || true
        sleep 2
        OLLAMA_DEBUG=1 ollama serve &
        sleep 5

    - name: Verify authentication
      run: |
        echo "SSH key fingerprint:"
        ssh-keygen -l -f ~/.ollama/id_ed25519.pub
        
        echo "\nTesting registry connection:"
        curl -v https://registry.ollama.com/v1/auth || true

    - name: Create and push test model
      env:
        OLLAMA_DEBUG: 1
      run: |
        # Create model
        cat > Modelfile << 'EOF'
        FROM gemma:2b
        PARAMETER temperature 0.7
        EOF
        
        # Create and tag with namespace
        echo "Creating model..."
        ollama create test-debug -f Modelfile
        echo "Copying with namespace..."
        ollama cp test-debug llm_hub/test-debug
        
        echo "Current models:"
        ollama list
        
        echo "Pushing model..."
        OLLAMA_HOST=https://registry.ollama.com ollama push llm_hub/test-debug

    - name: Debug on failure
      if: failure()
      run: |
        echo "Ollama logs:"
        cat ~/.ollama/logs/ollama.log || true
        
        echo "\nSSH agent info:"
        ssh-add -l || true
        
        echo "\nRegistry auth test:"
        curl -v -H "Authorization: Bearer $(cat ~/.ollama/id_ed25519 | base64)" \
          https://registry.ollama.com/v1/auth || true

    - name: Clean up
      if: always()
      run: |
        pkill ollama || true
        ollama rm test-debug llm_hub/test-debug || true
